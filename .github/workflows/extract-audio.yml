name: Extract YouTube Audio
on:
  repository_dispatch:
    types: [extract-audio]

jobs:
  extract:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
          
      - name: Install yt-dlp
        run: pip install yt-dlp
        
      - name: Extract audio
        env:
          VIDEO_URL: ${{ github.event.client_payload.video_url }}
          VIDEO_TITLE: ${{ github.event.client_payload.title }}
        run: |
          echo "Processing: $VIDEO_TITLE"
          echo "URL: $VIDEO_URL"
          
          yt-dlp \
            --user-agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            --format "bestaudio[ext=m4a]/bestaudio/best" \
            --extract-audio \
            --audio-format mp3 \
            --audio-quality 192K \
            --output "audio.%(ext)s" \
            --no-check-certificates \
            --ignore-errors \
            "$VIDEO_URL"
            
      - name: Check audio file
        run: |
          if [ -f "audio.mp3" ]; then
            echo "Audio file created successfully"
            ls -la audio.mp3
          else
            echo "Looking for any audio files..."
            find . -name "*.mp3" -o -name "*.m4a" -o -name "*.webm" | head -5
            AUDIO_FILE=$(find . -name "*.mp3" -o -name "*.m4a" | head -n 1)
            if [ -n "$AUDIO_FILE" ]; then
              echo "Found: $AUDIO_FILE"
              cp "$AUDIO_FILE" audio.mp3
              echo "Renamed to audio.mp3"
            else
              echo "No audio file found"
              exit 1
            fi
          fi
          
      - name: Upload to file storage
        id: upload
        run: |
          echo "Uploading audio file..."
          RESPONSE=$(curl -s -F "file=@audio.mp3" https://file.io)
          echo "Response: $RESPONSE"
          
          DOWNLOAD_URL=$(echo "$RESPONSE" | grep -o '"link":"[^"]*' | cut -d'"' -f4)
          
          if [ -n "$DOWNLOAD_URL" ]; then
            echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT
            echo "Upload successful: $DOWNLOAD_URL"
          else
            echo "Upload failed"
            exit 1
          fi
          
      - name: Trigger n8n webhook
        env:
          N8N_WEBHOOK: ${{ secrets.N8N_WEBHOOK_URL }}
          TITLE: ${{ github.event.client_payload.title }}
          DESCRIPTION: ${{ github.event.client_payload.description }}
          VIDEO_URL: ${{ github.event.client_payload.video_url }}
          AUDIO_URL: ${{ steps.upload.outputs.download_url }}
        run: |
          echo "Calling webhook with audio URL: $AUDIO_URL"
          
          curl -X POST "$N8N_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d "{\"title\":\"$TITLE\",\"description\":\"$DESCRIPTION\",\"video_url\":\"$VIDEO_URL\",\"audio_url\":\"$AUDIO_URL\"}"
          
          echo "Webhook called successfully"
